@page "/turmas"
@using AdmSchoolApp.Domain.Models.Responses
@using AdmSchoolApp.Web.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize]
@inject IApiService ApiService
@inject IJSRuntime JS

<PageTitle>Turmas</PageTitle>

<div class="turmas-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-chalkboard-teacher me-2"></i>
            Turmas
        </h1>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="fas fa-plus me-2"></i>
            Nova Turma
        </button>
    </div>

    @if (_turmas == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <table id="turmasTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Ano</th>
                            <th>Qtd. Alunos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var turma in _turmas)
                        {
                            <tr>
                                <td>@turma.Id</td>
                                <td>@turma.Name</td>
                                <td>@turma.CreatedAt.Year</td>
                                <td>@turma.StudentCount</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" @onclick="() => EditTurma(turma)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTurma(turma.Id)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<ClassWithStudentCountResponse>? _turmas;

    protected override async Task OnInitializedAsync()
    {
        await LoadTurmasAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _turmas != null)
        {
            await JS.InvokeVoidAsync("initDataTable", "turmasTable");
        }
    }

    private async Task LoadTurmasAsync()
    {
        _turmas = (await ApiService.GetClassesAsync()).Items.ToList();
    }

    private void ShowCreateModal()
    {
        // Implementar modal de criação
    }

    private void EditTurma(ClassResponse turma)
    {
        // Implementar edição
    }

    private async Task DeleteTurma(Guid id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Deseja realmente excluir esta turma?");
        
        if (confirmed)
        {
            await ApiService.DeleteClassAsync(id);
            await LoadTurmasAsync();
            StateHasChanged();
        }
    }
}