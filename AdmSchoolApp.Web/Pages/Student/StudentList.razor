@page "/alunos"
@using AdmSchoolApp.Domain.Models.Responses
@using AdmSchoolApp.Web.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize]
@inject IApiService ApiService
@inject IJSRuntime JS

<PageTitle>Alunos</PageTitle>

<div class="alunos-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-user-graduate me-2"></i>
            Alunos
        </h1>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="fas fa-plus me-2"></i>
            Novo Aluno
        </button>
    </div>

    @if (_alunos == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <table id="alunosTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>CPF</th>
                            <th>Data Nascimento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var aluno in _alunos)
                        {
                            <tr>
                                <td>@aluno.Id</td>
                                <td>@aluno.Name</td>
                                <td>@aluno.Email</td>
                                <td>@aluno.Cpf</td>
                                <td>@aluno.BirthDate.ToString("dd/MM/yyyy")</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" @onclick="() => EditAluno(aluno)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteAluno(aluno.Id)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<StudentResponse>? _alunos;

    protected override async Task OnInitializedAsync()
    {
        await LoadAlunosAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _alunos != null)
        {
            await JS.InvokeVoidAsync("initDataTable", "alunosTable");
        }
    }

    private async Task LoadAlunosAsync()
    {
        _alunos = (await ApiService.GetStudentsAsync()).Items.ToList();
    }

    private void ShowCreateModal()
    {
        // Implementar modal de criação
    }

    private void EditAluno(StudentResponse aluno)
    {
        // Implementar edição
    }

    private async Task DeleteAluno(Guid id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Deseja realmente excluir este aluno?");
        
        if (confirmed)
        {
            await ApiService.DeleteStudentAsync(id);
            await LoadAlunosAsync();
            StateHasChanged();
        }
    }
}