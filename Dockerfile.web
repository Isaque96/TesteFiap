# Dockerfile.web
ARG APP_UID=1000
ARG APP_GID=1000

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src

# Copia os csproj para cache (ajuste conforme sua solução)
COPY ["AdmSchoolApp.Web/AdmSchoolApp.Web.csproj", "AdmSchoolApp.Web/"]
COPY ["AdmSchoolApp.Domain/AdmSchoolApp.Domain.csproj", "AdmSchoolApp.Domain/"]

RUN dotnet restore "AdmSchoolApp.Web/AdmSchoolApp.Web.csproj"

COPY . .
WORKDIR "/src/AdmSchoolApp.Web"

# Garanta que BUILD_CONFIGURATION está disponível aqui (ARG foi declarado no stage)
RUN dotnet build "AdmSchoolApp.Web.csproj" -c ${BUILD_CONFIGURATION} -o /app/build --no-restore
RUN dotnet publish "AdmSchoolApp.Web.csproj" -c ${BUILD_CONFIGURATION} -o /app/publish --no-restore

FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS runtime
ARG APP_UID=1000
ARG APP_GID=1000
ENV ASPNETCORE_URLS=http://+:80
WORKDIR /app

RUN addgroup --system appgroup --gid ${APP_GID} \
 && adduser --system --ingroup appgroup --uid ${APP_UID} --home /app appuser

COPY --from=build /app/publish/ ./
RUN chown -R appuser:appgroup /app

USER appuser
EXPOSE 80

ENTRYPOINT ["dotnet", "AdmSchoolApp.Web.dll"]