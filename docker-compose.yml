services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: adm_school_sqlserver
    environment:
      - SA_PASSWORD=SuaSenhaForte123!
      - ACCEPT_EULA=Y
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - adm_network
    restart: unless-stopped

  db-init:
    image: mcr.microsoft.com/mssql-tools
    container_name: adm_school_db_init
    depends_on:
      - sqlserver
    networks:
      - adm_network
    volumes:
      - ./dump.sql:/tmp/dump.sql:ro    # ajuste caminho do seu dump.sql
    environment:
      - SA_PASSWORD=SuaSenhaForte123!
    entrypoint:
      - sh
      - -c
      - |
        echo "Waiting for SQL Server..."
        until /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P "$$SA_PASSWORD" -Q "SELECT 1" >/dev/null 2>&1; do
          echo "  waiting..."
          sleep 2
        done
        echo "SQL Server is up â€” executing /tmp/dump.sql"
        /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P "$$SA_PASSWORD" -i /tmp/dump.sql
        echo "db-init finished"
    restart: "no"

  adm_school_api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: adm_school_api
    environment:
      - ConnectionStrings__DefaultConnection="Server=sqlserver,1433;Database=master;User Id=sa;Password=SuaSenhaForte123!;"
      - ASPNETCORE_ENVIRONMENT=Development
    ports:
      - "5000:80"
    networks:
      - adm_network
    depends_on:
      - sqlserver
    restart: unless-stopped

  adm_school_front:
    build:
      context: .
      dockerfile: Dockerfile.web
    container_name: adm_school_front
    depends_on:
      - adm_school_api
    environment:
      - BACKAPI__BASEURL=http://adm_school_api:80
    ports:
      - "5001:80"
    networks:
      - adm_network
    restart: unless-stopped

volumes:
  sqlserver_data:

networks:
  adm_network:
    driver: bridge